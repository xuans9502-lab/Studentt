<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√ÄY CHU·ªñI ¬∑ K·∫æT B·∫†N ¬∑ L·ª¨A T√çM ¬∑ CHAT</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        body {
            background: #030514;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            background-image: 
                radial-gradient(circle at 10% 20%, #1a0f2a 0%, #030514 90%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="%23ffd966" opacity="0.3"/><circle cx="20" cy="30" r="1" fill="%23ff5e9e" opacity="0.3"/><circle cx="80" cy="70" r="1" fill="%239d4eff" opacity="0.3"/></svg>');
            animation: stars 20s linear infinite;
        }

        @keyframes stars {
            from { background-position: 0 0; }
            to { background-position: 100px 100px; }
        }

        .phone {
            max-width: 500px;
            width: 100%;
            background: rgba(20, 10, 40, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 60px;
            padding: 24px 18px;
            box-shadow: 0 30px 50px #000000, 0 0 0 3px #ffd96680, 0 0 50px #9d4eff;
            border: 2px solid #9d4eff;
            color: #fff5e6;
            position: relative;
            overflow: hidden;
        }

        .phone::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), rgba(157, 78, 255, 0.1), transparent);
            animation: shine 8s linear infinite;
            pointer-events: none;
        }

        @keyframes shine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* header */
        .top {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            background: rgba(157, 78, 255, 0.2);
            padding: 16px;
            border-radius: 60px;
            border: 2px solid #9d4eff;
            position: relative;
            z-index: 1;
            backdrop-filter: blur(10px);
        }

        .avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, gold, #ffae42, #9d4eff);
            border-radius: 40% 60% 30% 70% / 50% 40% 60% 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: 800;
            color: white;
            box-shadow: 0 8px 30px #9d4eff;
            border: 3px solid white;
            animation: avatarGlow 3s infinite;
        }

        @keyframes avatarGlow {
            0%, 100% { box-shadow: 0 8px 30px #9d4eff; }
            50% { box-shadow: 0 8px 50px #ff5e9e; }
        }

        .name h1 {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(to right, #fff, #ffd966, #9d4eff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px #9d4eff;
        }

        .name .class {
            background: #2a1f4a;
            border-radius: 40px;
            padding: 6px 18px;
            font-size: 14px;
            border: 2px solid #9d4eff;
            width: fit-content;
            margin-top: 8px;
            font-weight: 700;
            color: #ffd966;
        }

        /* Tab chuy·ªÉn ƒë·ªïi ƒêƒÉng k√Ω / ƒêƒÉng nh·∫≠p */
        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            background: rgba(30, 15, 50, 0.7);
            border: 2px solid #9d4eff;
            border-radius: 40px;
            padding: 16px;
            text-align: center;
            font-size: 18px;
            font-weight: 900;
            color: #b0c0ff;
            cursor: pointer;
            transition: 0.3s;
            backdrop-filter: blur(10px);
        }

        .auth-tab.active {
            background: #9d4eff;
            color: white;
            box-shadow: 0 0 30px #9d4eff;
            border-color: gold;
        }

        /* Form ƒëƒÉng k√Ω / ƒëƒÉng nh·∫≠p */
        .auth-section {
            background: rgba(30, 15, 50, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 22px;
            margin-bottom: 20px;
            border: 3px solid #9d4eff;
            box-shadow: 0 0 30px #9d4eff;
        }

        .auth-title {
            font-size: 22px;
            font-weight: 900;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #9d4eff;
            text-shadow: 0 0 20px #9d4eff;
        }

        .auth-box {
            background: #1a0f2a;
            border-radius: 40px;
            padding: 30px;
            border: 3px solid #9d4eff;
            text-align: center;
        }

        .auth-box input {
            width: 100%;
            background: #2a1f4a;
            border: 3px solid #9d4eff;
            border-radius: 60px;
            padding: 16px 20px;
            font-size: 18px;
            color: white;
            outline: none;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .auth-box input:focus {
            border-color: gold;
            box-shadow: 0 0 30px gold;
        }

        .btn {
            background: linear-gradient(145deg, gold, #ffae42);
            border: none;
            border-radius: 60px;
            padding: 16px 28px;
            font-size: 18px;
            font-weight: 900;
            color: #0a0c18;
            cursor: pointer;
            box-shadow: 0 8px 0 #b26f00, 0 0 20px gold;
            transition: 0.1s;
            border: 2px solid white;
            width: 100%;
        }

        .btn:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #b26f00, 0 0 30px gold;
        }

        .btn.purple {
            background: linear-gradient(145deg, #9d4eff, #6b2fbf);
            box-shadow: 0 8px 0 #4a1f8a, 0 0 20px #9d4eff;
        }

        .btn.small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .btn.pink {
            background: linear-gradient(145deg, #ff5e9e, #ff2e7a);
            box-shadow: 0 5px 0 #a01a4a;
        }

        /* MAIN APP */
        #mainApp {
            display: none;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            background: rgba(30, 15, 50, 0.5);
            padding: 10px;
            border-radius: 60px;
            border: 2px solid #9d4eff;
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 700;
            transition: 0.3s;
            color: #b0c0ff;
        }

        .nav-tab.active {
            background: #9d4eff;
            color: white;
            box-shadow: 0 0 20px #9d4eff;
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Khu v·ª±c b·∫°n b√® */
        .friends-section {
            background: rgba(30, 15, 50, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 18px;
            margin: 15px 0;
            border: 3px solid #ff5e9e;
            box-shadow: 0 0 30px #ff5e9e;
        }

        .friends-title {
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 15px;
            color: #ff9ec0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .friend-search {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .friend-search input {
            flex: 1;
            background: #2a1f4a;
            border: 3px solid #ff5e9e;
            border-radius: 60px;
            padding: 12px 16px;
            font-size: 16px;
            color: white;
            outline: none;
        }

        .friend-search button {
            background: linear-gradient(145deg, #ff5e9e, #ff2e7a);
            border: none;
            border-radius: 60px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 900;
            color: white;
            cursor: pointer;
            box-shadow: 0 5px 0 #a01a4a;
            border: 2px solid white;
        }

        .friend-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .friend-item {
            background: #2a1f4a;
            border-radius: 40px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid #ff5e9e;
            cursor: pointer;
            transition: 0.2s;
        }

        .friend-item:hover {
            transform: translateX(5px);
            border-color: #9d4eff;
        }

        .friend-item.online {
            border-color: #00ff88;
            box-shadow: 0 0 15px #00ff88;
        }

        .friend-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .friend-name {
            font-weight: 700;
            color: gold;
        }

        .friend-streak {
            font-size: 14px;
            color: #ff9ec0;
        }

        .friend-rank {
            font-size: 12px;
            background: #1a0f2a;
            padding: 2px 8px;
            border-radius: 20px;
            border: 1px solid #9d4eff;
        }

        .friend-actions {
            display: flex;
            gap: 5px;
        }

        .friend-actions button {
            background: #9d4eff;
            border: none;
            border-radius: 40px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            border: 2px solid white;
        }

        .friend-actions button.pink {
            background: #ff5e9e;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff88;
            display: inline-block;
            margin-left: 5px;
            box-shadow: 0 0 10px #00ff88;
        }

        .offline-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
            display: inline-block;
            margin-left: 5px;
        }

        .search-result {
            background: #2a1f4a;
            border-radius: 40px;
            padding: 16px;
            margin-top: 10px;
            text-align: center;
            border: 2px solid #ff5e9e;
        }

        /* CHAT SECTION */
        .chat-section {
            background: rgba(30, 15, 50, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 18px;
            margin: 15px 0;
            border: 3px solid #9d4eff;
            box-shadow: 0 0 30px #9d4eff;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .chat-header h3 {
            font-size: 18px;
            color: #ff9ec0;
        }

        .chat-friend-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .chat-friend-item {
            background: #2a1f4a;
            border-radius: 30px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid #9d4eff;
            cursor: pointer;
        }

        .chat-friend-item.active {
            background: #4a2f8a;
            border-color: gold;
        }

        .chat-friend-item .unread {
            background: #ff5e9e;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 900;
        }

        .chat-messages {
            background: #1a0f2a;
            border-radius: 30px;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 2px solid #9d4eff;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
        }

        .message.sent {
            align-items: flex-end;
        }

        .message.received {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background: linear-gradient(145deg, #9d4eff, #6b2fbf);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received .message-bubble {
            background: #2a1f4a;
            color: white;
            border-bottom-left-radius: 5px;
            border: 1px solid #9d4eff;
        }

        .message-time {
            font-size: 10px;
            color: #b0c0ff;
            margin-top: 3px;
            margin-left: 5px;
            margin-right: 5px;
        }

        .message-heart {
            color: #ff5e9e;
            font-size: 14px;
            margin-left: 5px;
            cursor: pointer;
            animation: heartBeat 1s infinite;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input-area input {
            flex: 1;
            background: #2a1f4a;
            border: 3px solid #9d4eff;
            border-radius: 60px;
            padding: 12px 16px;
            font-size: 14px;
            color: white;
            outline: none;
        }

        .chat-input-area button {
            background: linear-gradient(145deg, #9d4eff, #6b2fbf);
            border: none;
            border-radius: 60px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 900;
            color: white;
            cursor: pointer;
            box-shadow: 0 5px 0 #4a1f8a;
            border: 2px solid white;
        }

        .chat-input-area button.heart-btn {
            background: linear-gradient(145deg, #ff5e9e, #ff2e7a);
            box-shadow: 0 5px 0 #a01a4a;
        }

        /* Th√¥ng tin user */
        .user-stats {
            display: flex;
            justify-content: space-between;
            background: rgba(30, 15, 50, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 16px;
            margin: 10px 0;
            border: 2px solid #9d4eff;
            box-shadow: 0 0 30px #9d4eff;
        }

        .stat-item {
            text-align: center;
            position: relative;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 900;
            color: gold;
            text-shadow: 0 0 20px gold;
        }

        .stat-label {
            font-size: 14px;
            color: #ff9ec0;
        }

        /* Rank bar */
        .rank-bar {
            background: rgba(30, 15, 50, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 60px;
            padding: 16px;
            margin: 15px 0;
            border: 3px solid #9d4eff;
            box-shadow: 0 0 30px #9d4eff;
        }

        .rank-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .rank-name {
            font-size: 22px;
            font-weight: 900;
            color: gold;
            text-shadow: 0 0 20px gold;
        }

        .exp-bar {
            width: 100%;
            height: 20px;
            background: #1a0f2a;
            border-radius: 30px;
            overflow: hidden;
            border: 2px solid #9d4eff;
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffae42, gold, #9d4eff);
            width: 0%;
            transition: width 0.3s;
            box-shadow: 0 0 20px #9d4eff;
        }

        /* streak v√† t√™n */
        .streak-name {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(30, 15, 50, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 16px 20px;
            margin: 20px 0;
            border: 3px solid #9d4eff;
            box-shadow: 0 0 30px #9d4eff;
        }

        .user-name-display {
            font-size: 26px;
            font-weight: 900;
            color: gold;
            text-shadow: 0 0 20px gold;
        }

        .current-streak {
            font-size: 26px;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .fire-icon {
            font-size: 32px;
            filter: drop-shadow(0 0 20px #ff8c42);
            transition: all 0.3s;
        }

        .fire-icon.purple {
            filter: drop-shadow(0 0 30px #9d4eff);
            color: #b87cff;
        }

        .star-icon {
            color: gold;
            font-size: 18px;
            margin-left: 5px;
        }

        /* milestone */
        .milestone-box {
            background: rgba(30, 15, 50, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 22px;
            border-left: 12px solid #9d4eff;
            min-height: 140px;
            margin: 20px 0;
            border: 3px solid #9d4eff;
            box-shadow: 0 0 30px #9d4eff;
        }

        .gift {
            text-align: center;
        }

        .gift-emoji {
            font-size: 48px;
            filter: drop-shadow(0 0 20px gold);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .gift-text {
            font-size: 20px;
            font-weight: 700;
            color: #ffdb9f;
            margin: 10px 0;
        }

        .gift-reward {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 18px;
            flex-wrap: wrap;
        }

        .locked {
            text-align: center;
            color: #b0c0ff;
            font-size: 18px;
            padding: 30px;
        }

        /* SHOP */
        .shop-section {
            background: rgba(30, 15, 50, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 18px;
            margin: 20px 0;
            border: 3px solid #ff5e9e;
            box-shadow: 0 0 30px #ff5e9e;
        }

        .shop-title {
            font-size: 22px;
            font-weight: 900;
            margin-bottom: 16px;
            color: #ff9ec0;
            text-shadow: 0 0 20px #ff5e9e;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .shop-item {
            background: #2a1f4a;
            border-radius: 30px;
            padding: 16px 8px;
            text-align: center;
            border: 2px solid #ff5e9e;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 5px 0 #4a1f4a;
        }

        .shop-item:hover {
            transform: scale(1.05);
            border-color: gold;
            box-shadow: 0 0 30px gold;
        }

        .shop-item-emoji {
            font-size: 32px;
        }

        .shop-item-name {
            font-size: 14px;
            font-weight: 700;
            margin: 5px 0;
        }

        .shop-item-price {
            color: gold;
            font-weight: 900;
        }

        .shop-item.streak-required {
            border-color: #9d4eff;
            background: #3a2f5a;
        }

        /* 4 m√¥n */
        .section-title {
            font-size: 22px;
            font-weight: 900;
            margin: 20px 0 15px;
            color: #9d4eff;
            text-shadow: 0 0 20px #9d4eff;
        }

        .subject-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px;
            margin: 20px 0;
        }

        .subject {
            background: linear-gradient(145deg, #1f1f4a, #12123f);
            border-radius: 50px;
            padding: 26px 8px;
            text-align: center;
            box-shadow: 0 12px 0 #0a0a20;
            cursor: pointer;
            border: 4px solid transparent;
            transition: 0.2s;
        }

        .subject.done {
            background: linear-gradient(145deg, #3f3f90, #2f2f80);
            border-color: #9d4eff;
            box-shadow: 0 12px 0 #4a1f8a, 0 0 30px #9d4eff;
            transform: translateY(-3px);
        }

        .subject-emoji {
            font-size: 56px;
        }

        .subject-name {
            font-size: 24px;
            font-weight: 900;
        }

        .task {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #1f1f4a;
            padding: 18px 22px;
            border-radius: 60px;
            margin-bottom: 14px;
            border-left: 10px solid transparent;
            cursor: pointer;
            transition: 0.2s;
            border: 3px solid #4e4e9e;
        }

        .task:hover {
            transform: translateX(5px);
            box-shadow: 0 0 30px #9d4eff;
        }

        .task.done {
            border-left-color: #9d4eff;
            background: #2f2f6a;
            border-color: #9d4eff;
            box-shadow: 0 0 30px #9d4eff;
        }

        .task-left {
            display: flex;
            align-items: center;
            gap: 22px;
        }

        .check {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0a0a20;
            border: 4px solid #9d4eff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
        }

        .done .check {
            background: #9d4eff;
            color: black;
        }

        .warning {
            background: #4a1e2e;
            border-radius: 40px;
            padding: 18px;
            margin-top: 25px;
            border-left: 12px solid #ff6b6b;
            font-size: 18px;
            color: #ffc3c3;
            font-weight: 700;
            border: 3px solid red;
            animation: warningPulse 2s infinite;
        }

        @keyframes warningPulse {
            0%, 100% { box-shadow: 0 0 20px red; }
            50% { box-shadow: 0 0 40px #ff6b6b; }
        }

        .footer-note {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #b0c0ff;
            font-style: italic;
            text-shadow: 0 0 10px #9d4eff;
        }

        .logout-btn {
            background: #4a1e4a;
            border: 2px solid #ff5e9e;
            color: white;
            padding: 10px;
            border-radius: 40px;
            margin: 10px 0;
            cursor: pointer;
            text-align: center;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 5px;
        }

        .badge.streak {
            background: #ff5e9e;
            color: white;
        }

        .badge.vip {
            background: gold;
            color: black;
        }

        .badge.heart {
            background: #ff5e9e;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body>
    <div class="phone">
        <!-- header -->
        <div class="top">
            <div class="avatar">üëë</div>
            <div class="name">
                <h1>C√ÄY CHU·ªñI</h1>
                <div class="class">VIP ¬∑ K·∫æT B·∫†N ¬∑ L·ª¨A T√çM ¬∑ CHAT</div>
            </div>
        </div>

        <!-- Tab chuy·ªÉn ƒë·ªïi -->
        <div class="auth-tabs" id="authTabs">
            <div class="auth-tab active" id="registerTab">üìù ƒêƒÇNG K√ù</div>
            <div class="auth-tab" id="loginTab">üîë ƒêƒÇNG NH·∫¨P</div>
        </div>

        <!-- Form ƒêƒÇNG K√ù -->
        <div class="auth-section" id="registerSection">
            <div class="auth-title">üî∞ T·∫†O T√ÄI KHO·∫¢N M·ªöI</div>
            <div class="auth-box">
                <input type="text" id="regUsername" placeholder="T√™n t√†i kho·∫£n..." maxlength="20">
                <input type="password" id="regPassword" placeholder="M·∫≠t kh·∫©u...">
                <input type="password" id="regConfirmPassword" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u...">
                <button class="btn purple" id="registerBtn">üî∞ ƒêƒÇNG K√ù</button>
            </div>
        </div>

        <!-- Form ƒêƒÇNG NH·∫¨P -->
        <div class="auth-section" id="loginSection" style="display: none;">
            <div class="auth-title">üîë ƒêƒÇNG NH·∫¨P</div>
            <div class="auth-box">
                <input type="text" id="loginUsername" placeholder="T√™n t√†i kho·∫£n...">
                <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u...">
                <button class="btn purple" id="loginBtn">üîë ƒêƒÇNG NH·∫¨P</button>
            </div>
        </div>

        <!-- MAIN APP -->
        <div id="mainApp">
            <!-- N√∫t ƒëƒÉng xu·∫•t -->
            <div class="logout-btn" id="logoutBtn">üö™ ƒêƒÇNG XU·∫§T</div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <div class="nav-tab active" data-section="home">üè† HOME</div>
                <div class="nav-tab" data-section="friends">üë• B·∫†N B√à</div>
                <div class="nav-tab" data-section="chat">üí¨ CHAT</div>
                <div class="nav-tab" data-section="shop">üõí SHOP</div>
            </div>

            <!-- HOME SECTION -->
            <div class="section active" id="homeSection">
                <!-- T√™n v√† streak v·ªõi hi·ªáu ·ª©ng l·ª≠a t√≠m -->
                <div class="streak-name">
                    <span class="user-name-display" id="userNameDisplay">---</span>
                    <div class="current-streak">
                        <span id="streakNum">0</span>
                        <span class="fire-icon" id="fireIcon">üî•</span>
                    </div>
                </div>

                <!-- Th√¥ng s·ªë -->
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="diamondNum">50</div>
                        <div class="stat-label">üíé KIM C∆Ø∆†NG</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="expNum">0</div>
                        <div class="stat-label">‚ú® EXP</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="starNum">0</div>
                        <div class="stat-label">‚≠ê SAO</div>
                    </div>
                </div>

                <!-- Rank & EXP -->
                <div class="rank-bar">
                    <div class="rank-info">
                        <span class="rank-name" id="rankName">G·ªó</span>
                        <span id="expDisplay">0/100 EXP</span>
                    </div>
                    <div class="exp-bar">
                        <div class="exp-fill" id="expBar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- QU√Ä T·∫∂NG KHI ƒê·∫†T M·ªêC -->
                <div class="milestone-box" id="milestoneBox">
                    <div class="locked">üîí ƒê·∫°t streak ƒë·ªÉ nh·∫≠n qu√†</div>
                </div>

                <!-- 4 M√îN H·ªåC -->
                <div class="section-title">üìö H√îM NAY</div>
                <div class="subject-grid" id="subjectGrid">
                    <div class="subject" data-subj="toan">
                        <div class="subject-emoji">üßÆ</div>
                        <div class="subject-name">To√°n</div>
                    </div>
                    <div class="subject" data-subj="van">
                        <div class="subject-emoji">üìñ</div>
                        <div class="subject-name">VƒÉn</div>
                    </div>
                    <div class="subject" data-subj="anh">
                        <div class="subject-emoji">üá¨üáß</div>
                        <div class="subject-name">Anh</div>
                    </div>
                    <div class="subject" data-subj="khtn">
                        <div class="subject-emoji">üî¨</div>
                        <div class="subject-name">KHTN</div>
                    </div>
                </div>

                <!-- DANH S√ÅCH TASK -->
                <div id="taskList"></div>

                <!-- C·∫¢NH B√ÅO -->
                <div class="warning" id="warningMsg">
                    ‚ö†Ô∏è Ho√†n th√†nh ƒë·ªß 4 m√¥n ƒë·ªÉ +1 streak
                </div>
            </div>

            <!-- FRIENDS SECTION -->
            <div class="section" id="friendsSection">
                <div class="friends-section">
                    <div class="friends-title">
                        <span>üë•</span> K·∫æT B·∫†N C√ôNG C√ÄY (KH√îNG GI·ªöI H·∫†N)
                    </div>
                    <div class="friend-search">
                        <input type="text" id="searchFriendInput" placeholder="Nh·∫≠p t√™n b·∫°n b√®...">
                        <button id="searchFriendBtn">üîç T√åM</button>
                    </div>
                    <div class="search-result" id="searchFriendResult">
                        üîç Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm b·∫°n b√®
                    </div>
                    <div class="friends-title" style="margin-top: 15px;">
                        <span>üìã</span> DANH S√ÅCH B·∫†N B√à (<span id="friendCount">0</span>)
                    </div>
                    <div class="friend-list" id="friendListContainer">
                        <!-- Danh s√°ch b·∫°n b√® s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
                    </div>
                </div>
            </div>

            <!-- CHAT SECTION -->
            <div class="section" id="chatSection">
                <div class="chat-section">
                    <div class="chat-header">
                        <h3>üí¨ NH·∫ÆN TIN V·ªöI B·∫†N B√à</h3>
                        <span id="onlineCount" style="color: #00ff88;">0 online</span>
                    </div>
                    
                    <!-- Danh s√°ch b·∫°n b√® ƒë·ªÉ chat -->
                    <div class="chat-friend-list" id="chatFriendList">
                        <!-- S·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
                    </div>

                    <!-- Khung chat -->
                    <div id="chatBox" style="display: none;">
                        <div class="chat-header" style="justify-content: space-between;">
                            <span id="currentChatFriend"></span>
                            <button class="btn small pink" onclick="closeChat()">‚úñ ƒê√ìNG</button>
                        </div>
                        
                        <!-- Messages -->
                        <div class="chat-messages" id="chatMessages">
                            <!-- Messages s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        </div>

                        <!-- Input area -->
                        <div class="chat-input-area">
                            <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
                            <button class="heart-btn" onclick="sendHeart()" title="G·ª≠i tim">‚ù§Ô∏è</button>
                            <button onclick="sendMessage()">G·ª¨I</button>
                        </div>
                    </div>

                    <div id="noChatSelected" style="text-align: center; padding: 30px; color: #b0c0ff;">
                        üí¨ Ch·ªçn m·ªôt ng∆∞·ªùi b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán
                    </div>
                </div>
            </div>

            <!-- SHOP SECTION -->
            <div class="section" id="shopSection">
                <div class="shop-section">
                    <div class="shop-title">üõí SHOP KIM C∆Ø∆†NG (ƒê·ªí M·ªöI M·ªñI NG√ÄY)</div>
                    <div class="shop-grid" id="shopGrid">
                        <!-- Shop items s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
                    </div>
                </div>
            </div>

            <div class="footer-note">
                ‚ú® M·ªëc 50: L·ª≠a t√≠m | M·ªëc 100: 5000 EXP + 5000üíé | M·ªëc 500: SI√äU L·ª¨A T√çM
            </div>
        </div>
    </div>

    <script>
        (function() {
            // D·ªÆ LI·ªÜU
            let accounts = {};
            let currentUser = null;
            let onlineUsers = new Set();
            let currentChat = null;
            let messageInterval = null;

            // H·ªÜ TH·ªêNG RANK CHI TI·∫æT V·ªöI SAO
            const rankSystem = [
                // G·ªó (5 c·∫•p)
                { tier: 'G·ªó', star: 1, name: 'ü™µ G·ªó 1', minExp: 0, maxExp: 49 },
                { tier: 'G·ªó', star: 2, name: 'ü™µ G·ªó 2', minExp: 50, maxExp: 99 },
                { tier: 'G·ªó', star: 3, name: 'ü™µ G·ªó 3', minExp: 100, maxExp: 149 },
                { tier: 'G·ªó', star: 4, name: 'ü™µ G·ªó 4', minExp: 150, maxExp: 199 },
                { tier: 'G·ªó', star: 5, name: 'ü™µ G·ªó 5', minExp: 200, maxExp: 249 },
                
                // ƒê·ªìng (5 c·∫•p)
                { tier: 'ƒê·ªìng', star: 1, name: 'ü•â ƒê·ªìng 1', minExp: 250, maxExp: 299 },
                { tier: 'ƒê·ªìng', star: 2, name: 'ü•â ƒê·ªìng 2', minExp: 300, maxExp: 349 },
                { tier: 'ƒê·ªìng', star: 3, name: 'ü•â ƒê·ªìng 3', minExp: 350, maxExp: 399 },
                { tier: 'ƒê·ªìng', star: 4, name: 'ü•â ƒê·ªìng 4', minExp: 400, maxExp: 449 },
                { tier: 'ƒê·ªìng', star: 5, name: 'ü•â ƒê·ªìng 5', minExp: 450, maxExp: 499 },
                
                // B·∫°c (5 c·∫•p)
                { tier: 'B·∫°c', star: 1, name: 'ü•à B·∫°c 1', minExp: 500, maxExp: 549 },
                { tier: 'B·∫°c', star: 2, name: 'ü•à B·∫°c 2', minExp: 550, maxExp: 599 },
                { tier: 'B·∫°c', star: 3, name: 'ü•à B·∫°c 3', minExp: 600, maxExp: 649 },
                { tier: 'B·∫°c', star: 4, name: 'ü•à B·∫°c 4', minExp: 650, maxExp: 699 },
                { tier: 'B·∫°c', star: 5, name: 'ü•à B·∫°c 5', minExp: 700, maxExp: 749 },
                
                // V√†ng (5 c·∫•p)
                { tier: 'V√†ng', star: 1, name: 'ü•á V√†ng 1', minExp: 750, maxExp: 799 },
                { tier: 'V√†ng', star: 2, name: 'ü•á V√†ng 2', minExp: 800, maxExp: 849 },
                { tier: 'V√†ng', star: 3, name: 'ü•á V√†ng 3', minExp: 850, maxExp: 899 },
                { tier: 'V√†ng', star: 4, name: 'ü•á V√†ng 4', minExp: 900, maxExp: 949 },
                { tier: 'V√†ng', star: 5, name: 'ü•á V√†ng 5', minExp: 950, maxExp: 999 },
                
                // B·∫°ch kim (5 c·∫•p)
                { tier: 'B·∫°ch Kim', star: 1, name: '‚ö™ B·∫°ch Kim 1', minExp: 1000, maxExp: 1099 },
                { tier: 'B·∫°ch Kim', star: 2, name: '‚ö™ B·∫°ch Kim 2', minExp: 1100, maxExp: 1199 },
                { tier: 'B·∫°ch Kim', star: 3, name: '‚ö™ B·∫°ch Kim 3', minExp: 1200, maxExp: 1299 },
                { tier: 'B·∫°ch Kim', star: 4, name: '‚ö™ B·∫°ch Kim 4', minExp: 1300, maxExp: 1399 },
                { tier: 'B·∫°ch Kim', star: 5, name: '‚ö™ B·∫°ch Kim 5', minExp: 1400, maxExp: 1499 },
                
                // Kim c∆∞∆°ng (5 c·∫•p)
                { tier: 'Kim C∆∞∆°ng', star: 1, name: 'üíé Kim C∆∞∆°ng 1', minExp: 1500, maxExp: 1649 },
                { tier: 'Kim C∆∞∆°ng', star: 2, name: 'üíé Kim C∆∞∆°ng 2', minExp: 1650, maxExp: 1799 },
                { tier: 'Kim C∆∞∆°ng', star: 3, name: 'üíé Kim C∆∞∆°ng 3', minExp: 1800, maxExp: 1949 },
                { tier: 'Kim C∆∞∆°ng', star: 4, name: 'üíé Kim C∆∞∆°ng 4', minExp: 1950, maxExp: 2099 },
                { tier: 'Kim C∆∞∆°ng', star: 5, name: 'üíé Kim C∆∞∆°ng 5', minExp: 2100, maxExp: 2249 },
                
                // Huy·ªÅn tho·∫°i (5 c·∫•p)
                { tier: 'Huy·ªÅn Tho·∫°i', star: 1, name: 'üî• Huy·ªÅn Tho·∫°i 1', minExp: 2250, maxExp: 2499 },
                { tier: 'Huy·ªÅn Tho·∫°i', star: 2, name: 'üî• Huy·ªÅn Tho·∫°i 2', minExp: 2500, maxExp: 2749 },
                { tier: 'Huy·ªÅn Tho·∫°i', star: 3, name: 'üî• Huy·ªÅn Tho·∫°i 3', minExp: 2750, maxExp: 2999 },
                { tier: 'Huy·ªÅn Tho·∫°i', star: 4, name: 'üî• Huy·ªÅn Tho·∫°i 4', minExp: 3000, maxExp: 3249 },
                { tier: 'Huy·ªÅn Tho·∫°i', star: 5, name: 'üî• Huy·ªÅn Tho·∫°i 5', minExp: 3250, maxExp: 3499 },
                
                // Si√™u huy·ªÅn tho·∫°i (5 c·∫•p)
                { tier: 'Si√™u Huy·ªÅn Tho·∫°i', star: 1, name: '‚ö° Si√™u Huy·ªÅn Tho·∫°i 1', minExp: 3500, maxExp: 3749 },
                { tier: 'Si√™u Huy·ªÅn Tho·∫°i', star: 2, name: '‚ö° Si√™u Huy·ªÅn Tho·∫°i 2', minExp: 3750, maxExp: 3999 },
                { tier: 'Si√™u Huy·ªÅn Tho·∫°i', star: 3, name: '‚ö° Si√™u Huy·ªÅn Tho·∫°i 3', minExp: 4000, maxExp: 4249 },
                { tier: 'Si√™u Huy·ªÅn Tho·∫°i', star: 4, name: '‚ö° Si√™u Huy·ªÅn Tho·∫°i 4', minExp: 4250, maxExp: 4499 },
                { tier: 'Si√™u Huy·ªÅn Tho·∫°i', star: 5, name: '‚ö° Si√™u Huy·ªÅn Tho·∫°i 5', minExp: 4500, maxExp: 4749 },
                
                // Cao th·ªß (5 c·∫•p)
                { tier: 'Cao Th·ªß', star: 1, name: 'üëë Cao Th·ªß 1', minExp: 4750, maxExp: 4999 },
                { tier: 'Cao Th·ªß', star: 2, name: 'üëë Cao Th·ªß 2', minExp: 5000, maxExp: 5249 },
                { tier: 'Cao Th·ªß', star: 3, name: 'üëë Cao Th·ªß 3', minExp: 5250, maxExp: 5499 },
                { tier: 'Cao Th·ªß', star: 4, name: 'üëë Cao Th·ªß 4', minExp: 5500, maxExp: 5749 },
                { tier: 'Cao Th·ªß', star: 5, name: 'üëë Cao Th·ªß 5', minExp: 5750, maxExp: 5999 },
                
                // ƒê·∫°i cao th·ªß (5 c·∫•p)
                { tier: 'ƒê·∫°i Cao Th·ªß', star: 1, name: 'üèÜ ƒê·∫°i Cao Th·ªß 1', minExp: 6000, maxExp: 6249 },
                { tier: 'ƒê·∫°i Cao Th·ªß', star: 2, name: 'üèÜ ƒê·∫°i Cao Th·ªß 2', minExp: 6250, maxExp: 6499 },
                { tier: 'ƒê·∫°i Cao Th·ªß', star: 3, name: 'üèÜ ƒê·∫°i Cao Th·ªß 3', minExp: 6500, maxExp: 6749 },
                { tier: 'ƒê·∫°i Cao Th·ªß', star: 4, name: 'üèÜ ƒê·∫°i Cao Th·ªß 4', minExp: 6750, maxExp: 6999 },
                { tier: 'ƒê·∫°i Cao Th·ªß', star: 5, name: 'üèÜ ƒê·∫°i Cao Th·ªß 5', minExp: 7000, maxExp: 7249 },
                
                // Th·∫ßn th√°nh (5 c·∫•p)
                { tier: 'Th·∫ßn Th√°nh', star: 1, name: 'ü™ê Th·∫ßn Th√°nh 1', minExp: 7250, maxExp: 7499 },
                { tier: 'Th·∫ßn Th√°nh', star: 2, name: 'ü™ê Th·∫ßn Th√°nh 2', minExp: 7500, maxExp: 7749 },
                { tier: 'Th·∫ßn Th√°nh', star: 3, name: 'ü™ê Th·∫ßn Th√°nh 3', minExp: 7750, maxExp: 7999 },
                { tier: 'Th·∫ßn Th√°nh', star: 4, name: 'ü™ê Th·∫ßn Th√°nh 4', minExp: 8000, maxExp: 8249 },
                { tier: 'Th·∫ßn Th√°nh', star: 5, name: 'ü™ê Th·∫ßn Th√°nh 5', minExp: 8250, maxExp: 8499 },
                
                // L·ª≠a t√≠m (5 c·∫•p)
                { tier: 'L·ª≠a T√≠m', star: 1, name: 'üíú L·ª≠a T√≠m 1', minExp: 8500, maxExp: 8749 },
                { tier: 'L·ª≠a T√≠m', star: 2, name: 'üíú L·ª≠a T√≠m 2', minExp: 8750, maxExp: 8999 },
                { tier: 'L·ª≠a T√≠m', star: 3, name: 'üíú L·ª≠a T√≠m 3', minExp: 9000, maxExp: 9249 },
                { tier: 'L·ª≠a T√≠m', star: 4, name: 'üíú L·ª≠a T√≠m 4', minExp: 9250, maxExp: 9499 },
                { tier: 'L·ª≠a T√≠m', star: 5, name: 'üíú L·ª≠a T√≠m 5', minExp: 9500, maxExp: 9749 },
                
                // Huy·ªÅn tho·∫°i vƒ©nh c·ª≠u (5 c·∫•p)
                { tier: 'Huy·ªÅn Tho·∫°i Vƒ©nh C·ª≠u', star: 1, name: '‚ôæÔ∏è HTVC 1', minExp: 9750, maxExp: 9999 },
                { tier: 'Huy·ªÅn Tho·∫°i Vƒ©nh C·ª≠u', star: 2, name: '‚ôæÔ∏è HTVC 2', minExp: 10000, maxExp: 10499 },
                { tier: 'Huy·ªÅn Tho·∫°i Vƒ©nh C·ª≠u', star: 3, name: '‚ôæÔ∏è HTVC 3', minExp: 10500, maxExp: 10999 },
                { tier: 'Huy·ªÅn Tho·∫°i Vƒ©nh C·ª≠u', star: 4, name: '‚ôæÔ∏è HTVC 4', minExp: 11000, maxExp: 11499 },
                { tier: 'Huy·ªÅn Tho·∫°i Vƒ©nh C·ª≠u', star: 5, name: '‚ôæÔ∏è HTVC 5', minExp: 11500, maxExp: 11999 }
            ];

            // QU√Ä THEO STREAK (n√¢ng l√™n 500 ng√†y)
            const streakRewards = [
                { day: 2, exp: 20, diamonds: 5, stars: 1, emoji: 'üéÆ', name: 'Game th·ªß' },
                { day: 3, exp: 30, diamonds: 8, stars: 1, emoji: 'üç¶', name: 'Kem ng·ªçt' },
                { day: 5, exp: 50, diamonds: 15, stars: 2, emoji: 'üçø', name: 'B·∫Øp rang' },
                { day: 7, exp: 70, diamonds: 25, stars: 2, emoji: 'üßã', name: 'Tr√† s·ªØa' },
                { day: 10, exp: 100, diamonds: 40, stars: 3, emoji: 'üçî', name: 'G√† r√°n' },
                { day: 15, exp: 150, diamonds: 70, stars: 3, emoji: 'üéÅ', name: 'H·ªôp qu√†' },
                { day: 20, exp: 200, diamonds: 100, stars: 4, emoji: 'üß∏', name: 'G·∫•u b√¥ng' },
                { day: 25, exp: 250, diamonds: 150, stars: 4, emoji: 'üéÆ', name: 'Tay c·∫ßm' },
                { day: 30, exp: 300, diamonds: 200, stars: 5, emoji: 'üí∞', name: 'Kho b√°u' },
                { day: 40, exp: 400, diamonds: 300, stars: 6, emoji: 'üëü', name: 'Gi√†y' },
                { day: 50, exp: 500, diamonds: 500, stars: 8, emoji: 'üî•', name: 'L·ª≠a t√≠m', special: 'purplefire' },
                { day: 60, exp: 600, diamonds: 700, stars: 10, emoji: 'üì±', name: 'ƒêi·ªán tho·∫°i' },
                { day: 70, exp: 700, diamonds: 900, stars: 12, emoji: 'üß•', name: '√Åo' },
                { day: 80, exp: 800, diamonds: 1200, stars: 15, emoji: 'üéÇ', name: 'Sinh nh·∫≠t' },
                { day: 90, exp: 900, diamonds: 1500, stars: 18, emoji: 'üï∂Ô∏è', name: 'K√≠nh' },
                { day: 100, exp: 5000, diamonds: 5000, stars: 50, emoji: 'üíú', name: 'ƒê·∫†I TI·ªÜC L·ª¨A T√çM' },
                { day: 120, exp: 1000, diamonds: 2000, stars: 20, emoji: 'üöó', name: 'Xe h∆°i' },
                { day: 150, exp: 1500, diamonds: 3000, stars: 30, emoji: 'üè†', name: 'Nh√†' },
                { day: 180, exp: 2000, diamonds: 4000, stars: 40, emoji: '‚úàÔ∏è', name: 'M√°y bay' },
                { day: 200, exp: 3000, diamonds: 6000, stars: 60, emoji: 'üöÄ', name: 'T√™n l·ª≠a' },
                { day: 250, exp: 4000, diamonds: 8000, stars: 80, emoji: 'üõ∏', name: 'UFO' },
                { day: 300, exp: 6000, diamonds: 10000, stars: 100, emoji: 'üåå', name: 'Thi√™n h√†' },
                { day: 350, exp: 8000, diamonds: 15000, stars: 150, emoji: '‚ö°', name: 'S·∫•m s√©t' },
                { day: 400, exp: 10000, diamonds: 20000, stars: 200, emoji: 'üëÅÔ∏è', name: 'Con m·∫Øt' },
                { day: 450, exp: 15000, diamonds: 30000, stars: 300, emoji: 'üëΩ', name: 'Ng∆∞·ªùi ngo√†i h√†nh tinh' },
                { day: 500, exp: 50000, diamonds: 100000, stars: 1000, emoji: 'üî•üî•', name: 'SI√äU L·ª¨A T√çM', special: 'superPurplefire' }
            ];

            // SHOP ITEMS
            const shopItems = [
                { id: 'exp_small', name: '20 EXP', emoji: '‚ú®', price: 20, type: 'exp', value: 20 },
                { id: 'exp_medium', name: '50 EXP', emoji: '‚ú®‚ú®', price: 45, type: 'exp', value: 50 },
                { id: 'exp_large', name: '100 EXP', emoji: '‚ú®‚ú®‚ú®', price: 80, type: 'exp', value: 100 },
                { id: 'diamond_small', name: '10 üíé', emoji: 'üíé', price: 5, type: 'diamonds', value: 10 },
                { id: 'diamond_medium', name: '50 üíé', emoji: 'üíéüíé', price: 20, type: 'diamonds', value: 50 },
                { id: 'diamond_large', name: '200 üíé', emoji: 'üíéüíéüíé', price: 70, type: 'diamonds', value: 200 },
                { id: 'star_small', name: '5 ‚≠ê', emoji: '‚≠ê', price: 30, type: 'stars', value: 5 },
                { id: 'star_medium', name: '20 ‚≠ê', emoji: '‚≠ê‚≠ê', price: 100, type: 'stars', value: 20 },
                { id: 'star_large', name: '50 ‚≠ê', emoji: '‚≠ê‚≠ê‚≠ê', price: 200, type: 'stars', value: 50 },
                { id: 'boost', name: 'Boost Streak', emoji: '‚ö°', price: 50, type: 'boost', value: 1 },
                { id: 'super_boost', name: 'Super Boost', emoji: '‚ö°‚ö°', price: 200, type: 'boost', value: 5 },
                { id: 'theme_basic', name: 'Theme C∆° b·∫£n', emoji: 'üé®', price: 30, type: 'theme' },
                { id: 'theme_vip', name: 'Theme VIP', emoji: 'üé≠', price: 100, type: 'theme' },
                { id: 'pet_cat', name: 'M√®o', emoji: 'üê±', price: 80, type: 'pet' },
                { id: 'pet_dog', name: 'Ch√≥', emoji: 'üê∂', price: 80, type: 'pet' },
                { id: 'pet_dragon', name: 'R·ªìng', emoji: 'üêâ', price: 200, type: 'pet' },
                { id: 'badge_bronze', name: 'Huy hi·ªáu ƒê·ªìng', emoji: 'üèÖ', price: 50, type: 'badge' },
                { id: 'badge_silver', name: 'Huy hi·ªáu B·∫°c', emoji: 'ü•à', price: 150, type: 'badge' },
                { id: 'badge_gold', name: 'Huy hi·ªáu V√†ng', emoji: 'ü•á', price: 300, type: 'badge' },
                { id: 'badge_platinum', name: 'Huy hi·ªáu B·∫°ch kim', emoji: 'üèÜ', price: 500, type: 'badge' },
                { id: 'purplefire', name: 'L·ª≠a T√≠m', emoji: 'üî•', price: 300, type: 'purplefire', streakRequired: 30 },
                { id: 'super_purplefire', name: 'Si√™u L·ª≠a T√≠m', emoji: 'üî•üî•', price: 1000, type: 'superPurplefire', streakRequired: 100 },
                { id: 'time_machine', name: 'C·ªó m√°y th·ªùi gian', emoji: '‚è∞', price: 500, type: 'time' },
                { id: 'double_exp', name: 'Double EXP 7 ng√†y', emoji: '2Ô∏è‚É£', price: 400, type: 'buff' },
                { id: 'lucky_wheel', name: 'V√≤ng quay may m·∫Øn', emoji: 'üé∞', price: 150, type: 'gacha' },
                { id: 'mystery_box', name: 'H·ªôp b√≠ ·∫©n', emoji: 'üì¶', price: 200, type: 'random' },
                { id: 'rainbow', name: 'C·∫ßu v·ªìng', emoji: 'üåà', price: 600, type: 'effect' },
                { id: 'galaxy', name: 'Thi√™n h√†', emoji: 'üåå', price: 800, type: 'effect' },
                { id: 'crown', name: 'V∆∞∆°ng mi·ªán', emoji: 'üëë', price: 1000, type: 'title' },
                { id: 'heart_emoji', name: 'Th·∫£ tim kh√¥ng gi·ªõi h·∫°n', emoji: '‚ù§Ô∏è', price: 200, type: 'heart_unlimited' },
                { id: 'super_heart', name: 'Si√™u tim', emoji: 'üíñ', price: 500, type: 'super_heart' }
            ];

            function createNewAccount(name, password) {
                return {
                    name: name,
                    password: password,
                    streak: 0,
                    exp: 0,
                    diamonds: 50,
                    stars: 0,
                    hearts: 100, // S·ªë tim c√≥ th·ªÉ g·ª≠i
                    subjects: { toan: false, van: false, anh: false, khtn: false },
                    lastDate: new Date().toDateString(),
                    todayCompleted: false,
                    inventory: [],
                    purpleFire: false,
                    superPurpleFire: false,
                    friends: [], // Kh√¥ng gi·ªõi h·∫°n
                    chats: {}, // L∆∞u tin nh·∫Øn v·ªõi t·ª´ng b·∫°n
                    lastSeen: {}, // L·∫ßn cu·ªëi xem tin nh·∫Øn
                    pets: [],
                    badges: [],
                    themes: [],
                    effects: [],
                    title: null,
                    buffs: {},
                    stats: {
                        totalTasks: 0,
                        totalStreak: 0,
                        highestStreak: 0,
                        friendsAdded: 0,
                        messagesSent: 0,
                        heartsSent: 0,
                        heartsReceived: 0
                    }
                };
            }

            function getRank(exp) {
                for (let i = rankSystem.length - 1; i >= 0; i--) {
                    if (exp >= rankSystem[i].minExp) return rankSystem[i];
                }
                return rankSystem[0];
            }

            function getNextRankExp(exp) {
                let currentRank = getRank(exp);
                for (let i = 0; i < rankSystem.length; i++) {
                    if (rankSystem[i].minExp > exp) return rankSystem[i].minExp;
                }
                return rankSystem[rankSystem.length - 1].maxExp;
            }

            // Format th·ªùi gian
            function getCurrentTime() {
                const now = new Date();
                return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            }

            // DOM
            const authTabs = document.getElementById('authTabs');
            const registerTab = document.getElementById('registerTab');
            const loginTab = document.getElementById('loginTab');
            const registerSection = document.getElementById('registerSection');
            const loginSection = document.getElementById('loginSection');
            const mainApp = document.getElementById('mainApp');
            
            // Register
            const regUsername = document.getElementById('regUsername');
            const regPassword = document.getElementById('regPassword');
            const regConfirmPassword = document.getElementById('regConfirmPassword');
            const registerBtn = document.getElementById('registerBtn');
            
            // Login
            const loginUsername = document.getElementById('loginUsername');
            const loginPassword = document.getElementById('loginPassword');
            const loginBtn = document.getElementById('loginBtn');
            
            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            
            // Navigation
            const navTabs = document.querySelectorAll('.nav-tab');
            const sections = document.querySelectorAll('.section');
            
            // Friend
            const searchFriendInput = document.getElementById('searchFriendInput');
            const searchFriendBtn = document.getElementById('searchFriendBtn');
            const searchFriendResult = document.getElementById('searchFriendResult');
            const friendListContainer = document.getElementById('friendListContainer');
            const friendCount = document.getElementById('friendCount');
            
            // Chat
            const chatFriendList = document.getElementById('chatFriendList');
            const chatBox = document.getElementById('chatBox');
            const noChatSelected = document.getElementById('noChatSelected');
            const currentChatFriend = document.getElementById('currentChatFriend');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const onlineCount = document.getElementById('onlineCount');
            
            // Main
            const userNameDisplay = document.getElementById('userNameDisplay');
            const streakNum = document.getElementById('streakNum');
            const fireIcon = document.getElementById('fireIcon');
            const diamondNum = document.getElementById('diamondNum');
            const expNum = document.getElementById('expNum');
            const starNum = document.getElementById('starNum');
            const rankName = document.getElementById('rankName');
            const expDisplay = document.getElementById('expDisplay');
            const expBar = document.getElementById('expBar');
            const milestoneBox = document.getElementById('milestoneBox');
            const taskList = document.getElementById('taskList');
            const warningMsg = document.getElementById('warningMsg');
            const subjectItems = document.querySelectorAll('.subject');
            const shopGrid = document.getElementById('shopGrid');

            // Load d·ªØ li·ªáu t·ª´ localStorage
            const savedAccounts = localStorage.getItem('accounts');
            if (savedAccounts) {
                accounts = JSON.parse(savedAccounts);
                // Kh·ªüi t·∫°o chats cho c√°c account c≈©
                Object.keys(accounts).forEach(key => {
                    if (!accounts[key].chats) accounts[key].chats = {};
                    if (!accounts[key].lastSeen) accounts[key].lastSeen = {};
                    if (!accounts[key].hearts) accounts[key].hearts = 100;
                });
            }

            // Tab chuy·ªÉn ƒë·ªïi
            registerTab.addEventListener('click', () => {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerSection.style.display = 'block';
                loginSection.style.display = 'none';
            });

            loginTab.addEventListener('click', () => {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginSection.style.display = 'block';
                registerSection.style.display = 'none';
            });

            // Navigation
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    navTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const sectionId = tab.dataset.section;
                    sections.forEach(s => s.classList.remove('active'));
                    
                    switch(sectionId) {
                        case 'home':
                            document.getElementById('homeSection').classList.add('active');
                            break;
                        case 'friends':
                            document.getElementById('friendsSection').classList.add('active');
                            updateFriendList();
                            break;
                        case 'chat':
                            document.getElementById('chatSection').classList.add('active');
                            updateChatList();
                            break;
                        case 'shop':
                            document.getElementById('shopSection').classList.add('active');
                            renderShop();
                            break;
                    }
                });
            });

            // ƒêƒÇNG K√ù
            registerBtn.addEventListener('click', () => {
                const name = regUsername.value.trim();
                const pwd = regPassword.value;
                const confirm = regConfirmPassword.value;

                if (!name || name.length < 3) {
                    alert('T√™n ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±');
                    return;
                }
                if (!pwd || pwd.length < 3) {
                    alert('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±');
                    return;
                }
                if (pwd !== confirm) {
                    alert('M·∫≠t kh·∫©u kh√¥ng kh·ªõp');
                    return;
                }
                if (accounts[name]) {
                    alert('T√™n n√†y ƒë√£ t·ªìn t·∫°i!');
                    return;
                }
                
                accounts[name] = createNewAccount(name, pwd);
                localStorage.setItem('accounts', JSON.stringify(accounts));
                
                alert('ƒêƒÉng k√Ω th√†nh c√¥ng! M·ªùi b·∫°n ƒëƒÉng nh·∫≠p');
                
                // Chuy·ªÉn sang tab ƒëƒÉng nh·∫≠p
                loginTab.click();
                
                // X√≥a form ƒëƒÉng k√Ω
                regUsername.value = '';
                regPassword.value = '';
                regConfirmPassword.value = '';
            });

            // ƒêƒÇNG NH·∫¨P
            loginBtn.addEventListener('click', () => {
                const name = loginUsername.value.trim();
                const pwd = loginPassword.value;

                if (!accounts[name]) {
                    alert('T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i');
                    return;
                }
                if (accounts[name].password !== pwd) {
                    alert('Sai m·∫≠t kh·∫©u');
                    return;
                }

                currentUser = name;
                onlineUsers.add(name);
                
                // ·∫®n c√°c ph·∫ßn auth
                authTabs.style.display = 'none';
                registerSection.style.display = 'none';
                loginSection.style.display = 'none';
                
                // Hi·ªán main app
                mainApp.style.display = 'block';
                
                userNameDisplay.textContent = name;
                
                // Ki·ªÉm tra l·ª≠a t√≠m
                const user = accounts[name];
                if (user.inventory.includes('purplefire') || user.streak >= 50) {
                    user.purpleFire = true;
                }
                if (user.inventory.includes('superPurplefire') || user.streak >= 500) {
                    user.superPurpleFire = true;
                }
                
                if (user.superPurpleFire) {
                    fireIcon.classList.add('purple');
                    fireIcon.style.filter = 'drop-shadow(0 0 30px #ff00ff)';
                } else if (user.purpleFire) {
                    fireIcon.classList.add('purple');
                }
                
                // B·∫Øt ƒë·∫ßu interval c·∫≠p nh·∫≠t online status
                startOnlineStatus();
                
                renderShop();
                updateFriendList();
                updateChatList();
                updateUI();
            });

            // ƒêƒÇNG XU·∫§T
            logoutBtn.addEventListener('click', () => {
                if (currentUser) {
                    onlineUsers.delete(currentUser);
                }
                currentUser = null;
                
                // D·ª´ng interval
                if (messageInterval) {
                    clearInterval(messageInterval);
                    messageInterval = null;
                }
                
                // Hi·ªán l·∫°i ph·∫ßn auth
                authTabs.style.display = 'flex';
                registerSection.style.display = 'block';
                loginSection.style.display = 'none';
                
                // ·∫®n main app
                mainApp.style.display = 'none';
                
                // Reset active tab
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                
                // X√≥a form login
                loginUsername.value = '';
                loginPassword.value = '';
            });

            // Online status simulation
            function startOnlineStatus() {
                // Random m·ªôt s·ªë b·∫°n b√® online
                setInterval(() => {
                    if (!currentUser) return;
                    
                    const user = accounts[currentUser];
                    onlineUsers.clear();
                    onlineUsers.add(currentUser);
                    
                    // Random 30% b·∫°n b√® online
                    user.friends.forEach(friend => {
                        if (Math.random() < 0.3) {
                            onlineUsers.add(friend);
                        }
                    });
                    
                    updateChatList();
                }, 10000);
            }

            // T√åM KI·∫æM B·∫†N B√à
            searchFriendBtn.addEventListener('click', () => {
                const searchName = searchFriendInput.value.trim();
                
                if (!searchName) {
                    searchFriendResult.innerHTML = '‚ùå Vui l√≤ng nh·∫≠p t√™n c·∫ßn t√¨m';
                    return;
                }
                
                if (!accounts[searchName]) {
                    searchFriendResult.innerHTML = '‚ùå Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n n√†y';
                    return;
                }
                
                if (searchName === currentUser) {
                    searchFriendResult.innerHTML = '‚ùå Kh√¥ng th·ªÉ k·∫øt b·∫°n v·ªõi ch√≠nh m√¨nh';
                    return;
                }
                
                const user = accounts[currentUser];
                if (user.friends.includes(searchName)) {
                    searchFriendResult.innerHTML = '‚úÖ ƒê√£ l√† b·∫°n b√® r·ªìi';
                    return;
                }
                
                const friendRank = getRank(accounts[searchName].exp);
                searchFriendResult.innerHTML = `
                    ‚úÖ T√¨m th·∫•y: ${searchName}<br>
                    üî• Streak: ${accounts[searchName].streak} ng√†y<br>
                    üèÜ Rank: ${friendRank.name}<br>
                    ‚≠ê Sao: ${accounts[searchName].stars || 0}<br>
                    <button class="btn purple small" style="margin-top: 10px;" onclick="addFriend('${searchName}')">‚ûï K·∫æT B·∫†N</button>
                    <button class="btn pink small" style="margin-top: 10px;" onclick="sendFriendRequest('${searchName}')">üíå G·ª¨I L·ªúI M·ªúI</button>
                `;
            });

            // H√†m th√™m b·∫°n b√® (ƒë·ªÉ global cho onclick)
            window.addFriend = function(friendName) {
                const user = accounts[currentUser];
                if (!user.friends.includes(friendName)) {
                    user.friends.push(friendName);
                    
                    // Kh·ªüi t·∫°o chat cho b·∫°n m·ªõi
                    if (!user.chats) user.chats = {};
                    if (!user.chats[friendName]) {
                        user.chats[friendName] = [];
                    }
                    
                    // Th√™m v√†o friend c·ªßa ng∆∞·ªùi kia
                    if (!accounts[friendName].friends.includes(currentUser)) {
                        accounts[friendName].friends.push(currentUser);
                    }
                    
                    // Kh·ªüi t·∫°o chat cho ng∆∞·ªùi kia
                    if (!accounts[friendName].chats) accounts[friendName].chats = {};
                    if (!accounts[friendName].chats[currentUser]) {
                        accounts[friendName].chats[currentUser] = [];
                    }
                    
                    user.stats.friendsAdded++;
                    localStorage.setItem('accounts', JSON.stringify(accounts));
                    
                    searchFriendResult.innerHTML = `‚úÖ ƒê√£ k·∫øt b·∫°n v·ªõi ${friendName}`;
                    searchFriendInput.value = '';
                    
                    // G·ª≠i tin nh·∫Øn t·ª± ƒë·ªông
                    sendAutoMessage(friendName, 'üëã Ch√†o b·∫°n, m√¨nh v·ª´a k·∫øt b·∫°n!');
                    
                    updateFriendList();
                    updateChatList();
                }
            };

            // G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n
            window.sendFriendRequest = function(friendName) {
                alert(`üíå ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n ƒë·∫øn ${friendName}`);
            };

            // G·ª≠i tin nh·∫Øn t·ª± ƒë·ªông
            function sendAutoMessage(friendName, message) {
                const user = accounts[currentUser];
                const time = getCurrentTime();
                
                if (!user.chats) user.chats = {};
                if (!user.chats[friendName]) user.chats[friendName] = [];
                
                user.chats[friendName].push({
                    sender: currentUser,
                    message: message,
                    time: time,
                    type: 'text',
                    hearts: []
                });
                
                // L∆∞u v√†o chat c·ªßa ng∆∞·ªùi nh·∫≠n
                if (!accounts[friendName].chats) accounts[friendName].chats = {};
                if (!accounts[friendName].chats[currentUser]) accounts[friendName].chats[currentUser] = [];
                
                accounts[friendName].chats[currentUser].push({
                    sender: currentUser,
                    message: message,
                    time: time,
                    type: 'text',
                    hearts: []
                });
                
                localStorage.setItem('accounts', JSON.stringify(accounts));
            }

            // X√≥a b·∫°n b√®
            window.removeFriend = function(friendName) {
                if (confirm(`X√≥a ${friendName} kh·ªèi danh s√°ch b·∫°n b√®?`)) {
                    const user = accounts[currentUser];
                    user.friends = user.friends.filter(f => f !== friendName);
                    
                    // X√≥a chat
                    if (user.chats && user.chats[friendName]) {
                        delete user.chats[friendName];
                    }
                    
                    // X√≥a kh·ªèi friend c·ªßa ng∆∞·ªùi kia
                    if (accounts[friendName]) {
                        accounts[friendName].friends = accounts[friendName].friends.filter(f => f !== currentUser);
                        if (accounts[friendName].chats && accounts[friendName].chats[currentUser]) {
                            delete accounts[friendName].chats[currentUser];
                        }
                    }
                    
                    localStorage.setItem('accounts', JSON.stringify(accounts));
                    
                    if (currentChat === friendName) {
                        closeChat();
                    }
                    
                    updateFriendList();
                    updateChatList();
                }
            };

            // Xem th√¥ng tin b·∫°n b√®
            window.viewFriend = function(friendName) {
                const friend = accounts[friendName];
                const friendRank = getRank(friend.exp);
                alert(`üë§ ${friendName}\n` +
                      `üî• Streak: ${friend.streak}\n` +
                      `‚ú® EXP: ${friend.exp}\n` +
                      `üíé Kim c∆∞∆°ng: ${friend.diamonds}\n` +
                      `‚≠ê Sao: ${friend.stars || 0}\n` +
                      `üèÜ Rank: ${friendRank.name}\n` +
                      `üí¨ Tin nh·∫Øn: ${friend.stats?.messagesSent || 0}\n` +
                      `‚ù§Ô∏è Tim g·ª≠i/nh·∫≠n: ${friend.stats?.heartsSent || 0}/${friend.stats?.heartsReceived || 0}`);
            };

            // G·ª≠i qu√† cho b·∫°n
            window.giftFriend = function(friendName) {
                const amount = prompt('Nh·∫≠p s·ªë kim c∆∞∆°ng mu·ªën t·∫∑ng (t·ªëi thi·ªÉu 10):', '10');
                if (amount && !isNaN(amount) && parseInt(amount) >= 10) {
                    const user = accounts[currentUser];
                    const friend = accounts[friendName];
                    
                    if (user.diamonds >= parseInt(amount)) {
                        user.diamonds -= parseInt(amount);
                        friend.diamonds += parseInt(amount);
                        localStorage.setItem('accounts', JSON.stringify(accounts));
                        
                        // G·ª≠i tin nh·∫Øn th√¥ng b√°o
                        sendAutoMessage(friendName, `üéÅ ƒê√£ t·∫∑ng b·∫°n ${amount} üíé!`);
                        
                        alert(`‚úÖ ƒê√£ t·∫∑ng ${amount} üíé cho ${friendName}`);
                        updateUI();
                        updateChatList();
                    } else {
                        alert('‚ùå Kh√¥ng ƒë·ªß kim c∆∞∆°ng!');
                    }
                }
            };

            // M·ªü chat v·ªõi b·∫°n
            window.openChat = function(friendName) {
                currentChat = friendName;
                currentChatFriend.textContent = `üí¨ Chat v·ªõi ${friendName} ${onlineUsers.has(friendName) ? 'üü¢ Online' : '‚ö´ Offline'}`;
                
                chatBox.style.display = 'block';
                noChatSelected.style.display = 'none';
                
                // ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
                const user = accounts[currentUser];
                if (!user.lastSeen) user.lastSeen = {};
                user.lastSeen[friendName] = Date.now();
                
                loadMessages();
                
                // B·∫Øt ƒë·∫ßu interval load tin nh·∫Øn m·ªõi
                if (messageInterval) clearInterval(messageInterval);
                messageInterval = setInterval(loadMessages, 3000);
            };

            // ƒê√≥ng chat
            window.closeChat = function() {
                currentChat = null;
                chatBox.style.display = 'none';
                noChatSelected.style.display = 'block';
                if (messageInterval) {
                    clearInterval(messageInterval);
                    messageInterval = null;
                }
            };

            // Load messages
            function loadMessages() {
                if (!currentChat || !currentUser) return;
                
                const user = accounts[currentUser];
                if (!user.chats) user.chats = {};
                if (!user.chats[currentChat]) user.chats[currentChat] = [];
                
                const messages = user.chats[currentChat];
                let html = '';
                
                messages.forEach((msg, index) => {
                    const isSent = msg.sender === currentUser;
                    const heartsCount = msg.hearts ? msg.hearts.length : 0;
                    
                    html += `
                        <div class="message ${isSent ? 'sent' : 'received'}">
                            <div class="message-bubble">
                                ${msg.type === 'heart' ? '‚ù§Ô∏è ' : ''}${msg.message}
                                ${heartsCount > 0 ? `<span class="message-heart" onclick="addHeartToMessage('${currentChat}', ${index})">‚ù§Ô∏è ${heartsCount}</span>` : ''}
                            </div>
                            <div class="message-time">
                                ${msg.time}
                                ${!isSent ? `<span style="margin-left: 5px;" onclick="sendHeartToMessage('${currentChat}')">üíó</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                chatMessages.innerHTML = html || '<div style="text-align: center; color: #b0c0ff; padding: 20px;">Ch∆∞a c√≥ tin nh·∫Øn</div>';
                
                // Scroll xu·ªëng cu·ªëi
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // C·∫≠p nh·∫≠t lastSeen
                user.lastSeen[currentChat] = Date.now();
            }

            // G·ª≠i tin nh·∫Øn
            window.sendMessage = function() {
                const message = chatInput.value.trim();
                if (!message || !currentChat) return;
                
                const user = accounts[currentUser];
                const time = getCurrentTime();
                
                if (!user.chats) user.chats = {};
                if (!user.chats[currentChat]) user.chats[currentChat] = [];
                
                user.chats[currentChat].push({
                    sender: currentUser,
                    message: message,
                    time: time,
                    type: 'text',
                    hearts: []
                });
                
                // L∆∞u v√†o chat c·ªßa ng∆∞·ªùi nh·∫≠n
                if (!accounts[currentChat].chats) accounts[currentChat].chats = {};
                if (!accounts[currentChat].chats[currentUser]) accounts[currentChat].chats[currentUser] = [];
                
                accounts[currentChat].chats[currentUser].push({
                    sender: currentUser,
                    message: message,
                    time: time,
                    type: 'text',
                    hearts: []
                });
                
                // C·∫≠p nh·∫≠t stats
                if (!user.stats) user.stats = {};
                user.stats.messagesSent = (user.stats.messagesSent || 0) + 1;
                
                chatInput.value = '';
                localStorage.setItem('accounts', JSON.stringify(accounts));
                
                loadMessages();
            };

            // G·ª≠i tim
            window.sendHeart = function() {
                if (!currentChat) return;
                
                const user = accounts[currentUser];
                const time = getCurrentTime();
                
                // Ki·ªÉm tra s·ªë tim
                if (user.hearts <= 0 && !user.inventory.includes('heart_unlimited')) {
                    alert('‚ùå B·∫°n ƒë√£ h·∫øt tim! Mua th√™m trong shop nh√©!');
                    return;
                }
                
                if (!user.inventory.includes('heart_unlimited')) {
                    user.hearts = (user.hearts || 100) - 1;
                }
                
                if (!user.chats) user.chats = {};
                if (!user.chats[currentChat]) user.chats[currentChat] = [];
                
                const heartMsg = {
                    sender: currentUser,
                    message: 'üíó',
                    time: time,
                    type: 'heart',
                    hearts: [currentUser]
                };
                
                user.chats[currentChat].push(heartMsg);
                
                // L∆∞u v√†o chat c·ªßa ng∆∞·ªùi nh·∫≠n
                if (!accounts[currentChat].chats) accounts[currentChat].chats = {};
                if (!accounts[currentChat].chats[currentUser]) accounts[currentChat].chats[currentUser] = [];
                
                accounts[currentChat].chats[currentUser].push(heartMsg);
                
                // C·∫≠p nh·∫≠t stats
                if (!user.stats) user.stats = {};
                user.stats.heartsSent = (user.stats.heartsSent || 0) + 1;
                
                if (!accounts[currentChat].stats) accounts[currentChat].stats = {};
                accounts[currentChat].stats.heartsReceived = (accounts[currentChat].stats.heartsReceived || 0) + 1;
                
                localStorage.setItem('accounts', JSON.stringify(accounts));
                
                loadMessages();
            };

            // Th·∫£ tim v√†o tin nh·∫Øn
            window.addHeartToMessage = function(friendName, messageIndex) {
                const user = accounts[currentUser];
                const messages = user.chats[friendName];
                
                if (messages && messages[messageIndex]) {
                    if (!messages[messageIndex].hearts) {
                        messages[messageIndex].hearts = [];
                    }
                    
                    if (!messages[messageIndex].hearts.includes(currentUser)) {
                        messages[messageIndex].hearts.push(currentUser);
                        
                        // C·∫≠p nh·∫≠t cho ng∆∞·ªùi kia
                        const friendMessages = accounts[friendName].chats[currentUser];
                        if (friendMessages && friendMessages[messageIndex]) {
                            if (!friendMessages[messageIndex].hearts) {
                                friendMessages[messageIndex].hearts = [];
                            }
                            friendMessages[messageIndex].hearts.push(currentUser);
                        }
                        
                        localStorage.setItem('accounts', JSON.stringify(accounts));
                        loadMessages();
                    }
                }
            };

            // G·ª≠i tim nhanh
            window.sendHeartToMessage = function(friendName) {
                sendHeart();
            };

            // C·∫≠p nh·∫≠t danh s√°ch chat
            function updateChatList() {
                const user = accounts[currentUser];
                if (!user) return;
                
                let online = 0;
                let html = '';
                
                user.friends.forEach(friend => {
                    const friendData = accounts[friend];
                    if (!friendData) return;
                    
                    const isOnline = onlineUsers.has(friend);
                    if (isOnline) online++;
                    
                    // ƒê·∫øm tin nh·∫Øn ch∆∞a ƒë·ªçc
                    let unreadCount = 0;
                    if (friendData.chats && friendData.chats[currentUser]) {
                        const lastSeen = user.lastSeen?.[friend] || 0;
                        unreadCount = friendData.chats[currentUser].filter(msg => {
                            return msg.sender === friend && new Date(`2024-01-01 ${msg.time}`).getTime() > lastSeen;
                        }).length;
                    }
                    
                    html += `
                        <div class="chat-friend-item ${currentChat === friend ? 'active' : ''} ${isOnline ? 'online' : ''}" onclick="openChat('${friend}')">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span>${friend}</span>
                                ${isOnline ? '<span class="online-dot"></span>' : '<span class="offline-dot"></span>'}
                                ${unreadCount > 0 ? `<span class="unread">${unreadCount}</span>` : ''}
                            </div>
                            <span class="friend-streak">üî• ${friendData.streak}</span>
                        </div>
                    `;
                });
                
                onlineCount.textContent = `${online} online`;
                chatFriendList.innerHTML = html || '<div style="text-align: center; padding: 20px;">üë• Ch∆∞a c√≥ b·∫°n b√®</div>';
            }

            // C·∫≠p nh·∫≠t danh s√°ch b·∫°n b√®
            function updateFriendList() {
                const user = accounts[currentUser];
                if (!user) return;
                
                friendCount.textContent = user.friends.length;
                
                if (user.friends.length === 0) {
                    friendListContainer.innerHTML = '<div style="text-align: center; padding: 20px;">üë• Ch∆∞a c√≥ b·∫°n b√®</div>';
                    return;
                }
                
                let html = '';
                user.friends.forEach(friend => {
                    const friendData = accounts[friend];
                    if (friendData) {
                        const friendRank = getRank(friendData.exp);
                        const isOnline = onlineUsers.has(friend);
                        html += `
                            <div class="friend-item ${isOnline ? 'online' : ''}">
                                <div class="friend-info">
                                    <span class="friend-name">${friend}</span>
                                    <span class="friend-streak">üî• ${friendData.streak}</span>
                                    <span class="friend-rank">${friendRank.tier}</span>
                                    <span class="star-icon">‚≠ê${friendData.stars || 0}</span>
                                    ${isOnline ? '<span class="online-dot"></span>' : ''}
                                </div>
                                <div class="friend-actions">
                                    <button onclick="openChat('${friend}')">üí¨</button>
                                    <button onclick="giftFriend('${friend}')">üéÅ</button>
                                    <button onclick="viewFriend('${friend}')">üëÅÔ∏è</button>
                                    <button class="pink" onclick="sendHeartToFriend('${friend}')">‚ù§Ô∏è</button>
                                    <button onclick="removeFriend('${friend}')">‚ùå</button>
                                </div>
                            </div>
                        `;
                    }
                });
                friendListContainer.innerHTML = html;
            }

            // G·ª≠i tim cho b·∫°n (kh√¥ng c·∫ßn v√†o chat)
            window.sendHeartToFriend = function(friendName) {
                const user = accounts[currentUser];
                
                if (user.hearts <= 0 && !user.inventory.includes('heart_unlimited')) {
                    alert('‚ùå B·∫°n ƒë√£ h·∫øt tim! Mua th√™m trong shop nh√©!');
                    return;
                }
                
                if (!user.inventory.includes('heart_unlimited')) {
                    user.hearts = (user.hearts || 100) - 1;
                }
                
                sendAutoMessage(friendName, 'üíó G·ª≠i b·∫°n m·ªôt tr√°i tim!');
                
                user.stats.heartsSent = (user.stats.heartsSent || 0) + 1;
                accounts[friendName].stats.heartsReceived = (accounts[friendName].stats.heartsReceived || 0) + 1;
                
                alert(`‚ù§Ô∏è ƒê√£ g·ª≠i tim ƒë·∫øn ${friendName}`);
                updateUI();
            };

            // Render shop
            function renderShop() {
                const user = accounts[currentUser];
                if (!user) return;
                
                let html = '';
                
                // Random 12 items m·ªói l·∫ßn load
                const shuffled = [...shopItems].sort(() => 0.5 - Math.random());
                const selectedItems = shuffled.slice(0, 12);
                
                selectedItems.forEach(item => {
                    const canBuy = !item.streakRequired || user.streak >= item.streakRequired;
                    html += `
                        <div class="shop-item ${!canBuy ? 'streak-required' : ''}" 
                             data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}'
                             onclick="buyItem(${JSON.stringify(item).replace(/'/g, "&apos;")})">
                            <div class="shop-item-emoji">${item.emoji}</div>
                            <div class="shop-item-name">${item.name}</div>
                            <div class="shop-item-price">üíé${item.price}</div>
                            ${item.streakRequired ? `<div class="badge streak">üî•${item.streakRequired}+</div>` : ''}
                        </div>
                    `;
                });
                
                shopGrid.innerHTML = html;
            }

            // Mua item
            window.buyItem = function(item) {
                if (!currentUser) return;
                
                const user = accounts[currentUser];
                
                if (item.streakRequired && user.streak < item.streakRequired) {
                    alert(`‚ùå C·∫ßn streak ${item.streakRequired} ng√†y ƒë·ªÉ mua item n√†y!`);
                    return;
                }
                
                if (user.diamonds >= item.price) {
                    user.diamonds -= item.price;
                    
                    switch(item.type) {
                        case 'exp':
                            user.exp += item.value;
                            alert(`‚ú® +${item.value} EXP`);
                            break;
                        case 'diamonds':
                            user.diamonds += item.value;
                            alert(`üíé +${item.value} Kim c∆∞∆°ng`);
                            break;
                        case 'stars':
                            user.stars = (user.stars || 0) + item.value;
                            alert(`‚≠ê +${item.value} Sao`);
                            break;
                        case 'boost':
                            user.streak += item.value;
                            alert(`‚ö° Boost +${item.value} streak!`);
                            break;
                        case 'purplefire':
                            user.purpleFire = true;
                            user.inventory.push('purplefire');
                            fireIcon.classList.add('purple');
                            alert('üî• ƒê√£ m·ªü kh√≥a L·ª¨A T√çM vƒ©nh vi·ªÖn');
                            break;
                        case 'superPurplefire':
                            user.superPurpleFire = true;
                            user.inventory.push('superPurplefire');
                            fireIcon.classList.add('purple');
                            fireIcon.style.filter = 'drop-shadow(0 0 30px #ff00ff)';
                            alert('üî•üî• ƒê√£ m·ªü kh√≥a SI√äU L·ª¨A T√çM vƒ©nh vi·ªÖn');
                            break;
                        case 'time':
                            user.streak = Math.max(0, user.streak - 1);
                            alert('‚è∞ ƒê√£ quay l·∫°i 1 ng√†y!');
                            break;
                        case 'heart_unlimited':
                            user.inventory.push('heart_unlimited');
                            alert('‚ù§Ô∏è B√¢y gi·ªù b·∫°n c√≥ th·ªÉ th·∫£ tim kh√¥ng gi·ªõi h·∫°n!');
                            break;
                        case 'super_heart':
                            sendAutoMessageToAllFriends('üíñ G·ª≠i m·ªçi ng∆∞·ªùi si√™u tim!');
                            alert('üíñ ƒê√£ g·ª≠i si√™u tim ƒë·∫øn t·∫•t c·∫£ b·∫°n b√®!');
                            break;
                        case 'random':
                            const randomExp = Math.floor(Math.random() * 100) + 50;
                            const randomDiamonds = Math.floor(Math.random() * 50) + 20;
                            const randomStars = Math.floor(Math.random() * 10) + 1;
                            user.exp += randomExp;
                            user.diamonds += randomDiamonds;
                            user.stars = (user.stars || 0) + randomStars;
                            alert(`üé≤ Nh·∫≠n ƒë∆∞·ª£c: ${randomExp} EXP, ${randomDiamonds} üíé v√† ${randomStars} ‚≠ê`);
                            break;
                        default:
                            user.inventory.push(item.id);
                            alert(`‚úÖ Mua th√†nh c√¥ng: ${item.name}`);
                    }
                    
                    localStorage.setItem('accounts', JSON.stringify(accounts));
                    updateUI();
                    renderShop();
                } else {
                    alert('‚ùå Kh√¥ng ƒë·ªß kim c∆∞∆°ng!');
                }
            };

            // G·ª≠i tin nh·∫Øn ƒë·∫øn t·∫•t c·∫£ b·∫°n b√®
            function sendAutoMessageToAllFriends(message) {
                const user = accounts[currentUser];
                const time = getCurrentTime();
                
                user.friends.forEach(friend => {
                    if (!user.chats) user.chats = {};
                    if (!user.chats[friend]) user.chats[friend] = [];
                    
                    user.chats[friend].push({
                        sender: currentUser,
                        message: message,
                        time: time,
                        type: 'system',
                        hearts: []
                    });
                    
                    if (accounts[friend]) {
                        if (!accounts[friend].chats) accounts[friend].chats = {};
                        if (!accounts[friend].chats[currentUser]) accounts[friend].chats[currentUser] = [];
                        
                        accounts[friend].chats[currentUser].push({
                            sender: currentUser,
                            message: message,
                            time: time,
                            type: 'system',
                            hearts: []
                        });
                    }
                });
                
                localStorage.setItem('accounts', JSON.stringify(accounts));
            }

            // RENDER TASKS
            function renderTasks(user) {
                const tasks = [
                    { key: 'toan', name: 'To√°n', emoji: 'üßÆ' },
                    { key: 'van', name: 'VƒÉn', emoji: 'üìñ' },
                    { key: 'anh', name: 'Anh', emoji: 'üá¨üáß' },
                    { key: 'khtn', name: 'KHTN', emoji: 'üî¨' }
                ];

                let html = '';
                tasks.forEach(t => {
                    const isDone = user.subjects[t.key];
                    html += `
                        <div class="task ${isDone ? 'done' : ''}" data-key="${t.key}">
                            <div class="task-left">
                                <span class="check">${isDone ? '‚úì' : ''}</span>
                                <span style="font-size: 22px;">${t.emoji} ${t.name}</span>
                            </div>
                        </div>
                    `;
                });
                taskList.innerHTML = html;

                document.querySelectorAll('.task').forEach(task => {
                    task.addEventListener('click', function() {
                        if (!currentUser) return;
                        
                        const key = this.dataset.key;
                        const user = accounts[currentUser];
                        
                        user.subjects[key] = !user.subjects[key];
                        if (user.subjects[key]) {
                            user.stats.totalTasks++;
                        }
                        
                        checkAndUpdateStreak(user);
                        updateUI();
                    });
                });
            }

            // KI·ªÇM TRA STREAK
            function checkAndUpdateStreak(user) {
                const today = new Date().toDateString();
                
                if (user.lastDate !== today) {
                    if (!(user.subjects.toan && user.subjects.van && user.subjects.anh && user.subjects.khtn)) {
                        // Reset streak n·∫øu kh√¥ng ho√†n th√†nh ƒë·ªß
                        user.stats.totalStreak += user.streak; // L∆∞u t·ªïng streak
                        user.streak = 0;
                    }
                    user.subjects = { toan: false, van: false, anh: false, khtn: false };
                    user.todayCompleted = false;
                    user.lastDate = today;
                }

                const allDone = user.subjects.toan && user.subjects.van && user.subjects.anh && user.subjects.khtn;
                
                if (allDone && !user.todayCompleted) {
                    user.streak += 1;
                    if (user.streak > user.stats.highestStreak) {
                        user.stats.highestStreak = user.streak;
                    }
                    user.todayCompleted = true;
                    
                    // Ph·∫ßn th∆∞·ªüng c∆° b·∫£n
                    user.exp += 10;
                    user.diamonds += 5;
                    user.stars = (user.stars || 0) + 1;
                    
                    // Ki·ªÉm tra qu√† theo streak
                    streakRewards.forEach(reward => {
                        if (user.streak === reward.day) {
                            user.exp += reward.exp;
                            user.diamonds += reward.diamonds;
                            user.stars = (user.stars || 0) + (reward.stars || 0);
                            
                            if (reward.special === 'purplefire') {
                                user.purpleFire = true;
                                fireIcon.classList.add('purple');
                            }
                            if (reward.special === 'superPurplefire') {
                                user.superPurpleFire = true;
                                fireIcon.classList.add('purple');
                                fireIcon.style.filter = 'drop-shadow(0 0 30px #ff00ff)';
                            }
                            
                            // G·ª≠i th√¥ng b√°o cho b·∫°n b√®
                            user.friends.forEach(friend => {
                                sendAutoMessage(friend, `üéâ M√¨nh v·ª´a ƒë·∫°t m·ªëc ${reward.day} ng√†y! Nh·∫≠n ƒë∆∞·ª£c ${reward.name}!`);
                            });
                            
                            alert(`üéâ ƒê·∫†T M·ªêC ${reward.day} NG√ÄY!\nNh·∫≠n: ${reward.exp} EXP + ${reward.diamonds} üíé + ${reward.stars || 0} ‚≠ê`);
                        }
                    });
                    
                    localStorage.setItem('accounts', JSON.stringify(accounts));
                }
            }

            // UPDATE UI
            function updateUI() {
                if (!currentUser) return;
                
                const user = accounts[currentUser];
                const currentRank = getRank(user.exp);
                
                streakNum.textContent = user.streak;
                diamondNum.textContent = user.diamonds;
                expNum.textContent = user.exp;
                starNum.textContent = user.stars || 0;
                
                // Hi·ªáu ·ª©ng l·ª≠a t√≠m
                if (user.superPurpleFire) {
                    fireIcon.classList.add('purple');
                    fireIcon.style.filter = 'drop-shadow(0 0 30px #ff00ff)';
                } else if (user.purpleFire || user.streak >= 50) {
                    fireIcon.classList.add('purple');
                    fireIcon.style.filter = 'drop-shadow(0 0 20px #9d4eff)';
                } else {
                    fireIcon.classList.remove('purple');
                    fireIcon.style.filter = 'drop-shadow(0 0 20px #ff8c42)';
                }
                
                // Rank
                rankName.textContent = currentRank.name;
                
                // EXP bar
                const nextExp = getNextRankExp(user.exp);
                const prevExp = currentRank.minExp;
                const expNeeded = nextExp - prevExp;
                const expCurrent = user.exp - prevExp;
                const percent = Math.min(100, (expCurrent / expNeeded) * 100);
                
                expDisplay.textContent = `${user.exp}/${nextExp} EXP`;
                expBar.style.width = percent + '%';
                
                // Highlight subject
                subjectItems.forEach(item => {
                    const subj = item.dataset.subj;
                    if (user.subjects[subj]) {
                        item.classList.add('done');
                    } else {
                        item.classList.remove('done');
                    }
                });
                
                // Hi·ªÉn th·ªã qu√† streak
                const achieved = streakRewards.filter(r => r.day <= user.streak).pop();
                const nextReward = streakRewards.find(r => r.day > user.streak);
                
                if (achieved) {
                    milestoneBox.innerHTML = `
                        <div class="gift">
                            <div class="gift-emoji">${achieved.emoji}</div>
                            <div class="gift-text">M·ªëc ${achieved.day}: ${achieved.name}</div>
                            <div class="gift-reward">
                                <span>‚ú® +${achieved.exp} EXP</span>
                                <span>üíé +${achieved.diamonds}</span>
                                <span>‚≠ê +${achieved.stars || 0}</span>
                            </div>
                            ${nextReward ? `<div style="margin-top: 10px; font-size: 14px;">üîú M·ªëc ti·∫øp: ${nextReward.day} ng√†y</div>` : ''}
                        </div>
                    `;
                } else {
                    milestoneBox.innerHTML = `<div class="locked">üîí ƒê·∫°t 2 ng√†y ƒë·ªÉ nh·∫≠n qu√† ƒë·∫ßu ti√™n</div>`;
                }
                
                // Warning
                const allDone = user.subjects.toan && user.subjects.van && user.subjects.anh && user.subjects.khtn;
                if (!allDone) {
                    warningMsg.innerHTML = `‚ö†Ô∏è Ho√†n th√†nh ƒë·ªß 4 m√¥n h√¥m nay ƒë·ªÉ +1 streak`;
                } else {
                    warningMsg.innerHTML = `‚úÖ ƒê√É ƒê·ª¶ 4 M√îN! Ng√†y mai +1 streak`;
                }
                
                renderTasks(user);
            }

            // AUTO CHECK
            setInterval(() => {
                if (currentUser) {
                    const user = accounts[currentUser];
                    const today = new Date().toDateString();
                    
                    if (user.lastDate !== today) {
                        if (!(user.subjects.toan && user.subjects.van && user.subjects.anh && user.subjects.khtn)) {
                            user.stats.totalStreak += user.streak;
                            user.streak = 0;
                        }
                        user.subjects = { toan: false, van: false, anh: false, khtn: false };
                        user.todayCompleted = false;
                        user.lastDate = today;
                        
                        localStorage.setItem('accounts', JSON.stringify(accounts));
                    }
                    
                    updateUI();
                    if (currentChat) {
                        loadMessages();
                    }
                }
            }, 1000);

            // Enter ƒë·ªÉ g·ª≠i tin nh·∫Øn
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        })();
    </script>
</body>
</html>
